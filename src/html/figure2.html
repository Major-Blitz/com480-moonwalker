<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genre Counts Bubble Chart</title>
  <!-- use "../../" to debug locally, use moonwalker url to deploy on github -->
  <!-- <base href="https://major-blitz.github.io/com480-moonwalker/"> -->
  <!-- <base href="../../"> -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    #bubble-chart {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .bubble-chart text {
      pointer-events: none;
    }
    #year-label {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 20px;
      font-weight: bold;
      text-anchor: middle;
      fill: #333;
    }
    .refresh-icon {
      cursor: pointer;
      font-size: 24px;
      fill: #007bff;
    }
    .refresh-icon:hover {
      fill: #0056b3;
    }
  </style>
</head>
<body>
  <h1 id="chart-title">The popularity among different game genres</h1>
    <div class="center-justified-text" style="max-width: 800px; margin: 10px auto;">
      What types of games are the most popular? In this dynamic bubble chart, you can explore the changes in the number of games released in different genres over the years. Does it match your expectations?
    </div>
  <div id="app">
    <svg id="bubble-chart" width="954" height="550"></svg>
  </div>

  <script>
    const colours = {
      Action: "#ff6f61",
      Adventure: "#67c2b0",
      Fighting: "#ffb74d",
      Misc: "#81cfe0",
      Platform: "#ffd369",
      Puzzle: "#8aa29e",
      Racing: "#b2dfdb",
      "Role-Playing": "#ffab91",
      Shooter: "#9fa8da",
      Simulation: "#ffcc80",
      Sports: "#4db6ac",
      Strategy: "#b39ddb"
    };

    // Function to fetch data from the provided URL and parse it as CSV
    async function getData(url) {
      const response = await fetch(url);
      const data = await response.text();
      return d3.csvParse(data);
    }

    // Main function to load data and draw the chart
    async function main() {
      const genreCounts = await getData('datasets/genre-counts.csv');
      drawChart(genreCounts);
    }

    function drawChart(genreCounts) {
      const width = 954;
      const height = 450;

      const years = ["1980", "1985", "1990", "1995", "2000", "2005", "2010"];

      const svg = d3.select("#bubble-chart");

      const format = (value) => d3.format(".2s")(value);

      let yearIndex = 0; // Global variable for the current year index
      let timeoutIds = []; // Store all setTimeout IDs

      function updateChart() {
        if (yearIndex >= years.length) return; // Exit if the index exceeds the number of years

        const year = years[yearIndex];
        const data = genreCounts
          .map(d => ({
            name: d.Genre,
            value: +d[year],
            fill: colours[d.Genre] || "grey"
          }))
          .filter(d => d.value > 0);

        svg.selectAll("g.node").remove(); // Retain the refresh button, only remove node groups
        svg.selectAll("#year-label").remove(); // Remove existing year labels

        const pack = (data) =>
          d3.pack()
            .size([width - 2, height - 2])
            .padding(2)(d3.hierarchy({ children: data }).sum((d) => d.value));

        const root = pack(data);

        const nodes = svg.selectAll("g.node")
          .data(root.leaves(), d => d.data.name)
          .join("g")
          .attr("class", "node")
          .attr("transform", d => `translate(${d.x},${d.y})`);

        nodes.append("circle")
          .attr("r", d => d.r)
          .attr("fill", d => d.data.fill);

        nodes.append("text")
          .attr("dy", "0.35em")
          .attr("text-anchor", "middle")
          .attr("font-size", d => Math.min(2 * d.r, (2 * d.r - 8) / d.data.name.length * 2) + "px")
          .attr("fill", "white")
          .html(d => `${d.data.name}<tspan x="0" dy="1.2em" font-size="0.5em">${format(d.data.value)}</tspan>`);

        const simulation = d3.forceSimulation(root.leaves())
          .force("x", d3.forceX(width / 2).strength(0.05))
          .force("y", d3.forceY(height / 2).strength(0.05))
          .force("collide", d3.forceCollide(d => d.r + 1).strength(0.8))
          .on("tick", ticked);

        function ticked() {
          nodes.attr("transform", d => `translate(${d.x},${d.y})`);
        }

        // Add year label
        svg.append("text")
          .attr("id", "year-label")
          .attr("x", width / 2)
          .attr("y", height + 40)
          .text(`${year}-${parseInt(year) + 5}`);
      }

      function startAnimation() {
        // Clear all setTimeouts
        timeoutIds.forEach(id => clearTimeout(id));
        timeoutIds = []; // Reset timeoutIds

        yearIndex = 0; // Reset yearIndex
        function step() {
          updateChart();
          yearIndex++;
          if (yearIndex < years.length) {
            const id = setTimeout(step, 1000);
            timeoutIds.push(id); // Record setTimeout ID
          }
        }
        step();
      }

      startAnimation();

      // Add refresh button
      function addRefreshButton() {
        svg.selectAll(".refresh-icon").remove(); // Ensure multiple refresh buttons are not added

        svg.append("text")
          .attr("class", "refresh-icon")
          .attr("x", width - 30)
          .attr("y", 30)
          .text("âŸ³")
          .on("click", startAnimation);
      }

      addRefreshButton();
    }

    main();
  </script>
</body>
</html>
